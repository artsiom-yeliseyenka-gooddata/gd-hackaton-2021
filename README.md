# Gdc Mastercard Nudata react application

These instructions were generated by the `cookiecutter` template, feel free to update it based on actual application needs.

## Local development

### Requirements
 * `npm`

### Start application on development server
React application can be started by a single command:
```
$ cd gdc-mastercard-nudata
$ npm start
```
It will automatically start application on [localhost:3000](http://localhost:3000).

## Docker support
There is a multi-stage Dockerfile which can be used also for local validation
and mainly to the deployment in k8s.
Application is first build inside the `harbor.intgdc.com/tools/gdc-node:12.16.3` image
and the result static content is then added in `nginx` image

### Build docker image
```
$ docker build -t mastercard-nudata .
```

### Run application in docker
```
$ docker run -p 8080:8080 -it mastercard-nudata
```
You can access this application on [localhost:8080](http://localhost:8080).

## K8S support

Before proceeding, you should be aware of the k8s and CD basics.
Best place to start is [k8s developers guide](https://confluence.intgdc.com/display/plat/Kubernetes+Developers+Guideline)

### Continuous Deployment Integration
There is a generated file `.gdc-ii-config.yaml` and `Jenkinsfile` required
by our existing CD pipelines on [jenkins-ii](https://jenkins-ii.intgdc.com/).

If your repository is not yet configured, follow the steps described in
[k8s developers guide - ci-infra setup](https://confluence.intgdc.com/display/plat/Kubernetes+Developers+Guideline#KubernetesDevelopersGuideline-Step5-Definepipelinesinci-infrarepository).

To enable deployment of mastercard-nudata to our testing cluster,
you should update the [charts-config](https://github.com/gooddata/charts-config) repository.

More details can be found in [k8s developers guide - charts-config](https://confluence.intgdc.com/display/plat/Kubernetes+Developers+Guideline#KubernetesDevelopersGuideline-Step6-Defineserviceconfigurationincharts-configrepository).

### Testing of chart deployment on isolated k8s
You can deploy your own `k8s` instance type or `rat+k8s`. Alternatively you can
use local `minikube`.

To validate your application logic in chart, you can follow these steps:
 * build docker image and push it in [harbor](https://confluence.intgdc.com/display/plat/Kubernetes+Developers+Guideline#KubernetesDevelopersGuideline-DockerregistryforK8S)
```
$ docker login harbor.intgdc.com
$ docker tag mastercard-nudata harbor.intgdc.com/<your-namespace>/mastercard-nudata
$ docker push harbor.intgdc.com/<your-namespace>/mastercard-nudata
```
 * SSH to your k8s instance and clone the repository with the chart
```
$ ssh root@<k8s-instance-fqdn>
$ git clone git@github.com:<your-fork>/.git
```
 * install the chart from git directory with custom image from harbor namespace
```
$ cd /k8s/charts
$ helm upgrade --install mastercard-nudata mastercard-nudata \
    --set services.mastercardNuData.image.namespace=<your-namespace> \
    --wait --timeout 300
```
This will install the defined k8s objects in default namespaces (you can alternatively use
`--namespace <namespace>` in command above).
 * validate the created k8s objects
```
$ kubectl get pods
```

### Application routing
To test the application via Ingress (Istio) endpoint, you can install some extension like `ModHeader` and define header
"Host: local.mastercard-nudata.services.k8s.intgdc.com"
And then open the browser at: <k8s-instance/worker-url>:20080 and it should point you to the application.

For routing via GoodProxy on some specific URI, please reach Honeybadgers team to configure GoodProxy on defined clusters.

### Any issues?
Try to troubleshoot yourself, feel free to reach the [#team-seti](https://app.slack.com/client/T02G0PHRH/C52UC59PB) slack channel or somebody
from II team when you are lost.

## Deployment checklist

**Any change to your application Helm chart (including overwrites in charts-config repo) requires bump of the charts version in `k8s/charts/<YOUR_APP>/Chart.yaml`!!!**

[`CLUSTER_ID` mapping to GoodData environments](https://confluence.intgdc.com/display/plat/Instances+and+domains+naming+convention#Instancesanddomainsnamingconvention-ProductrelatedClusterIDsmapping)

To deploy an app follow these steps:

- Update [charts-config](https://github.com/gooddata/charts-config)
  - add chart to environment chart config `<CLUSTER_ID>.yaml` (eg. [stg3](https://github.com/gooddata/charts-config/blob/master/64.yaml))
  - add your app env specific values to `<CLUSTER_ID>/your_app.yaml` file (eg. [64/workspace-load-ui.yaml](https://github.com/gooddata/charts-config/blob/master/64/workspace-load-ui.yaml)
  - make sure:
    - that you set proper requested and limit resources
    - that you select correct k8s namespace to deploy (usually `client` for UI apps)
    - that you specify correct image namespace (`staging` for stagings, `stable` for prod)
  - for the first deployment you can use some dummy values for `image.tag` and chart version, they will be overwritten during deployment
  - create PR into `charts-config` repo and merge it
- Update [puppet](https://github.com/gooddata/puppet)
  - k8s runs on develop branch, so use it
  - if this is a fresh deployment:
    - add your `ingress host` into [client k8s class](https://github.com/gooddata/puppet/blob/develop/modules/gdc/manifests/client/k8s.pp)
    - set your `ingress host variable` in hiera through [global.yaml](https://github.com/gooddata/puppet/blob/develop/hieradata/global.yaml)- search for corresponding group of values like `gdc::client::k8s:`
    - overwrite your `ingress host` value in platform based overwrites [gdc-platform.yaml.erb](https://github.com/gooddata/puppet/blob/develop/modules/k8s/templates/gdc-platform.yaml.erb) - find section which corresponds to your values (eg. `client`)
  - enable monitoring- there is a `k8s::prometheus_rules_configmaps` list variable which must be updated with your monitoring rules name. It's placed in `<CLUSTER_ID>/k8s.yaml` file (eg. [stg3](https://github.com/gooddata/puppet/blob/develop/hieradata/cluster/64/k8s.yaml))
- Update your app repository
  - Update your Helm chart version to trigger the deployment to the new environment
    - bump `version` in your app repository `k8s/charts/<YOUR_APP>/Chart.yaml`
  - make also some dummy change in the code to trigger image build (update README, doc, ...)
  - create a PR, merge it and check that app was deployed to requested env, check Blueocean overview in Jenkins II for details
- Create ticket for Honeybadgers team to route public requests to your k8s app
    - Jira project WA
    - Slack ([team-honeybadgers](https://gooddata.slack.com/archives/CF8ANQ0RX))  
    - provide:
      - your app `ingress host`
      - path where app should be handled publicly and which possible rewrite to do (eg. `/public/app-path` to `/path`)
      - environment where app routing should be enabled
      - additional routing details (limit to some hostnames only?)

For more information about the deployment and Helm charts you can check [this presentation](https://docs.google.com/presentation/d/1O8QaeNWBLW6FjkpWQyn528_23dBdwE_3l08_heLVLww/edit?usp=sharing).
